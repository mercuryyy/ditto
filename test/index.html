<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LivePortrait (Browser + RunPod)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system; margin: 20px; }
    video { width: 360px; height: 270px; background:#000; border-radius:12px; }
    .row { display:flex; gap:20px; align-items:flex-start; flex-wrap: wrap; }
    input, button { font-size:16px; padding:8px 10px; }
    pre { background:#111; color:#ddd; padding:10px; border-radius:10px; width:min(780px, 100%); }
  </style>
</head>
<body>
  <h2>LivePortrait test (Browser driver → RunPod → LiveKit)</h2>

  <div class="row" style="gap:10px; margin-bottom:10px;">
    <label>Identity: <input id="identity" value="caller-1"></label>
    <label>Room: <input id="room" value="liveportrait-test"></label>
    <input id="avatar" type="file" accept="image/*">
    <button id="start">Start</button>
  </div>

  <div class="row">
    <div>
      <div>Driver (your camera)</div>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div>
      <div>LivePortrait Output</div>
      <video id="lpVideo" autoplay playsinline></video>
    </div>
  </div>

  <pre id="status"></pre>

  <!-- LiveKit UMD (single include) -->
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.min.js"></script>

  <script>
    // ---------- Safe logging ----------
    const statusEl = document.getElementById('status');
    function toLine(v) {
      if (v instanceof Error) return v.message || String(v);
      if (v === undefined) return 'undefined';
      if (v === null) return 'null';
      const t = typeof v;
      if (t === 'string' || t === 'number' || t === 'boolean') return String(v);
      try { return JSON.stringify(v); } catch { return '[object]'; }
    }
    function log(...args) {
      const line = args.map(toLine).join(' ');
      console.log(...args);
      statusEl.textContent += line + '\n';
    }

    // ---------- LiveKit ----------
    const LK = window.livekitClient || window.LivekitClient || window.LiveKitClient;
    if (!LK) alert('LiveKit JS failed to load. Hard refresh (Cmd+Shift+R).');
    const { Room, RoomEvent } = LK;

    let started = false;
    let room;

    // ---------- File -> base64 (no stack overflow) ----------
    function fileToBase64(file) {
      if (!file) return Promise.reject(new Error('Pick an avatar image'));
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const dataUrl = String(r.result || '');
          const comma = dataUrl.indexOf(',');
          resolve(comma >= 0 ? dataUrl.slice(comma + 1) : dataUrl);
        };
        r.onerror = () => reject(r.error || new Error('FileReader error'));
        r.readAsDataURL(file); // avoids spreading huge arrays
      });
    }

    async function start() {
      if (started) return; // prevent double click
      started = true;

      const identity = document.getElementById('identity').value || `web-${Date.now()}`;
      const roomName = document.getElementById('room').value || 'liveportrait-test';
      const avatarFile = document.getElementById('avatar').files[0];
      const localEl = document.getElementById('localVideo');
      const lpEl = document.getElementById('lpVideo');

      try {
        log('[ui] start clicked');

        // 1) Ask for mic/cam first
        if (!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia not supported');
        if (!location.hostname.match(/^localhost$/)) log('[warn] gUM needs HTTPS or localhost:', location.origin);
        log('[gUM] requesting mic+cam…');
        const localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: { width: 640, height: 480 }});
        log('[gUM] granted');
        localEl.srcObject = localStream;

        // 2) Fetch LiveKit token
        log('[api] GET /token');
        const tkRes = await fetch(`/token?identity=${encodeURIComponent(identity)}&room=${encodeURIComponent(roomName)}`);
        if (!tkRes.ok) throw new Error(`Token failed: ${tkRes.status} ${await tkRes.text()}`);
        const { token, url } = await tkRes.json();
        log('[api] token ok url=', url);

        // 3) Connect
        room = new Room({ adaptiveStream: true, dynacast: true });
        room.on(RoomEvent.ConnectionStateChanged, (state) => log('[lk] state:', state));
        log('[lk] connecting…');
        await room.connect(url, token);
        log('[lk] connected as', identity);

        // 4) Publish mic & cam
        await room.localParticipant.publishTrack(localStream.getAudioTracks()[0]);
        await room.localParticipant.publishTrack(localStream.getVideoTracks()[0], { name: 'driver' });
        log('[lk] published mic+camera');

        // 5) Kick RunPod worker
        const avatar_b64 = await fileToBase64(avatarFile);
        log('[api] POST /start-lp');
        const rpRes = await fetch('/start-lp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identity, room: roomName, avatar_b64, width: 512, height: 512, fps: 24, backend: 'torch' })
        });
        const rpData = await rpRes.json();
        if (!rpRes.ok) throw new Error(`RunPod failed: ${rpRes.status} ${toLine(rpData)}`);
        log('[runpod] job', rpData.jobId || '(no id)');

        // 6) Attach first LP video
        let attached = false;
        function tryAttach(p, pub) {
          if (attached) return;
          if (pub?.track && pub.track.kind === 'video') {
            if (pub.trackName && pub.trackName !== 'liveportrait') return;
            pub.track.attach(lpEl);
            attached = true;
            log('[lk] attached LP track from', p.identity, pub.trackName);
          }
        }
        room.on(RoomEvent.TrackSubscribed, (track, pub, participant) => {
          if (participant.identity !== identity && track.kind === 'video') tryAttach(participant, pub);
        });

        // NEW (defensive across LK v2 variants)
        const parts = room.participants && typeof room.participants.values === 'function'
        ? Array.from(room.participants.values())
        : [];

        for (const p of parts) {
        // v2 typically has videoTracks (Map); fallback to trackPublications
        const pubs =
            (p.videoTracks && typeof p.videoTracks.values === 'function')
            ? Array.from(p.videoTracks.values())
            : (p.trackPublications && typeof p.trackPublications.values === 'function')
                ? Array.from(p.trackPublications.values()).filter(tp => tp.kind === 'video')
                : [];
        for (const pub of pubs) {
            if (pub?.isSubscribed) tryAttach(p, pub);
        }
        }



        log('[ui] ready – waiting for LP video…');

      } catch (e) {
        console.error(e);
        alert(e?.message || String(e));
        log('[error]', e?.message || String(e));
        started = false; // allow retry
      }
    }

    document.getElementById('start').addEventListener('click', () => { start().catch(console.error); });
  </script>
</body>
</html>

